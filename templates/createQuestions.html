<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Questions</title>
</head>
<body>
    <h1>CREATE NEW QUESTIONS</h1>
    <form id="createQuestionsForm" method="POST" action="/save-question">
        <div>
            <label for="chooseQuestion">CHOOSE QUESTION</label>
            <select id="chooseQuestion" name="chooseQuestion" required>
                <option value="" selected>Select Question</option>
                <option value="multipleChoice">Multiple Choice Question</option>
                <option value="issuesAndStances">Issues and Controversies</option>
            </select>
        </div>

        <div id="dynamicFields"></div>
    </form>

    <script>
        const chooseQuestion = document.getElementById("chooseQuestion");
        const dynamicFields = document.getElementById("dynamicFields");

        let issues = []; // Array to store issues

        chooseQuestion.addEventListener("change", function () {
            const selectedQuestion = this.value;

            // Clear dynamic fields
            dynamicFields.innerHTML = "";

            if (selectedQuestion === "multipleChoice") {
                // Add fields for Multiple Choice Question
                const questionLabel = document.createElement("label");
                questionLabel.textContent = "Enter Question";
                questionLabel.setAttribute("for", "questionText");

                const questionInput = document.createElement("input");
                questionInput.setAttribute("type", "text");
                questionInput.setAttribute("id", "questionText");
                questionInput.setAttribute("name", "questionText");
                questionInput.setAttribute("placeholder", "Enter your question");
                questionInput.required = true;

                const pillarLabel = document.createElement("label");
                pillarLabel.textContent = "Select Pillar";
                pillarLabel.setAttribute("for", "pillarSelect");

                const pillarSelect = document.createElement("select");
                pillarSelect.setAttribute("id", "pillarSelect");
                pillarSelect.setAttribute("name", "pillarSelect");
                pillarSelect.required = true;

                // Load pillars dynamically
                fetch('/api/pillars')
                    .then(response => response.json())
                    .then(data => {
                        const defaultOption = document.createElement("option");
                        defaultOption.value = "";
                        defaultOption.textContent = "Select Pillar";
                        defaultOption.disabled = true;
                        defaultOption.selected = true;
                        pillarSelect.appendChild(defaultOption);

                        data.pillars.forEach(pillar => {
                            const option = document.createElement("option");
                            option.value = pillar;
                            option.textContent = pillar;
                            pillarSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error("Error loading pillars:", error);
                        alert("Failed to load pillars. Please try again.");
                    });

                const saveButton = document.createElement("button");
                saveButton.textContent = "Save Question";
                saveButton.type = "button";
                saveButton.id = "saveQuestion";

                dynamicFields.appendChild(questionLabel);
                dynamicFields.appendChild(questionInput);
                dynamicFields.appendChild(pillarLabel);
                dynamicFields.appendChild(pillarSelect);
                dynamicFields.appendChild(saveButton);

                saveButton.addEventListener("click", () => {
                    const questionText = questionInput.value.trim();
                    const pillar = pillarSelect.value;

                    if (!questionText || !pillar) {
                        alert("Please enter a question and select a pillar.");
                        return;
                    }

                    fetch("/save-question", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ questionText, pillar }),
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert("Question saved successfully!");
                                questionInput.value = "";
                                pillarSelect.selectedIndex = 0;
                            } else {
                                alert("Error saving question: " + data.message);
                            }
                        })
                        .catch(error => {
                            console.error("Error saving question:", error);
                            alert("Failed to save question.");
                        });
                });
            } else if (selectedQuestion === "issuesAndStances") {
                // Add dynamic fields for "Issues and Controversies"
                const head = document.createElement("h2");
                head.textContent = "ISSUES AND CONTROVERSIES";
                dynamicFields.appendChild(head);

                const newInput = document.createElement("input");
                newInput.setAttribute("type", "text");
                newInput.setAttribute("id", "dynamicTextarea");
                newInput.setAttribute("placeholder", "List issues here...");
                dynamicFields.append(newInput);

                const addButton = document.createElement("button");
                addButton.textContent = "Add Issue";
                addButton.type = "button";
                addButton.id = "buttonAdd";
                dynamicFields.appendChild(addButton);

                const issueList = document.createElement("ol");
                issueList.setAttribute("id", "issueList");
                dynamicFields.appendChild(issueList);

                const submitButton = document.createElement("button");
                submitButton.textContent = "Submit Issues";
                submitButton.type = "button";
                submitButton.id = "submitIssues";
                dynamicFields.appendChild(submitButton);

                // Re-render existing issues
                renderIssues(issueList);

                addButton.addEventListener("click", function () {
                    const issueValue = newInput.value.trim();
                    if (issueValue) {
                        issues.push(issueValue);
                        newInput.value = "";
                        renderIssues(issueList);
                    }
                });

                submitButton.addEventListener("click", function () {
                    fetch("/submit-issues", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ issues }),
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert("Issues saved successfully!");
                                issues = []; // Clear issues after saving
                                renderIssues(issueList);
                            } else {
                                alert("Error saving issues: " + data.message);
                            }
                        })
                        .catch(error => {
                            console.error("Error saving issues:", error);
                            alert("Failed to save issues.");
                        });
                });
            }
        });

        // Function to render issues
        function renderIssues(issueList) {
            issueList.innerHTML = ""; // Clear the list
            issues.forEach((issue, index) => {
                const li = document.createElement("li");
                li.textContent = issue;

                const delButton = document.createElement("button");
                delButton.textContent = "Delete";
                delButton.type = "button";
                delButton.addEventListener("click", function () {
                    issues.splice(index, 1); // Remove the issue from the array
                    renderIssues(issueList); // Re-render the list
                });

                li.appendChild(delButton);
                issueList.appendChild(li);
            });
        }
    </script>
</body>
</html>
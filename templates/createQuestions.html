<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Questions</title>
</head>
<body>
    <h1>CREATE NEW QUESTIONS</h1>
    <form id="createQuestionsForm" method="POST" action="/save-question">
        <div>
            <label for="chooseQuestion">CHOOSE QUESTION</label>
            <select id="chooseQuestion" name="chooseQuestion" required>
                <option value="choose" disabled selected>Select</option>
                <option value="multipleChoice">Multiple Choice Question</option>
                <option value="issuesAndStances">Issues and Controversies</option>
            </select>
        </div>

        <div id="dynamicFields"></div>
    </form>

    <div id="questionList">
        <h2>Stored Questions</h2>
        <ul id="questionsContainer"></ul>
    </div>
    
    <div id="issuesList" style="display: none;">
        <h2>Stored Issues</h2>
        <ul id="issuesContainer"></ul>
    </div>

    <script>
        const chooseQuestion = document.getElementById("chooseQuestion");
        const dynamicFields = document.getElementById("dynamicFields");

        let issues = []; // Array to store issues

        chooseQuestion.addEventListener("change", function () {
            const selectedQuestion = this.value;

            // Clear dynamic fields
            dynamicFields.innerHTML = "";

            // Show/hide the appropriate list container
            if (selectedQuestion === "multipleChoice") {
                document.getElementById("questionList").style.display = "block";
                document.getElementById("issuesList").style.display = "none";
                loadQuestions();
            } else if (selectedQuestion === "issuesAndStances") {
                document.getElementById("questionList").style.display = "none";
                document.getElementById("issuesList").style.display = "block";
                loadIssues();
            }

            if (selectedQuestion === "multipleChoice") {
                // Add fields for Multiple Choice Questions
                const questionLabel = document.createElement("label");
                questionLabel.textContent = "Enter Question";
                questionLabel.setAttribute("for", "questionText");

                const questionInput = document.createElement("input");
                questionInput.setAttribute("type", "text");
                questionInput.setAttribute("id", "questionText");
                questionInput.setAttribute("name", "questionText");
                questionInput.setAttribute("placeholder", "Enter your question");
                questionInput.required = true;

                const pillarLabel = document.createElement("label");
                pillarLabel.textContent = "Select Pillar";
                pillarLabel.setAttribute("for", "pillarSelect");

                const pillarSelect = document.createElement("select");
                pillarSelect.setAttribute("id", "pillarSelect");
                pillarSelect.setAttribute("name", "pillarSelect");
                pillarSelect.required = true;

                // Load pillars dynamically
                fetch('/api/pillars')
                    .then(response => response.json())
                    .then(data => {
                        const defaultOption = document.createElement("option");
                        defaultOption.value = "";
                        defaultOption.textContent = "Select Pillar";
                        defaultOption.disabled = true;
                        defaultOption.selected = true;
                        pillarSelect.appendChild(defaultOption);

                        data.pillars.forEach(pillar => {
                            const option = document.createElement("option");
                            option.value = pillar;
                            option.textContent = pillar;
                            pillarSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error("Error loading pillars:", error);
                        alert("Failed to load pillars. Please try again.");
                    });

                const saveButton = document.createElement("button");
                saveButton.textContent = "Save Question";
                saveButton.type = "button";
                saveButton.id = "saveQuestion";

                dynamicFields.appendChild(questionLabel);
                dynamicFields.appendChild(questionInput);
                dynamicFields.appendChild(pillarLabel);
                dynamicFields.appendChild(pillarSelect);
                dynamicFields.appendChild(saveButton);

                saveButton.addEventListener("click", () => {
                    const questionText = questionInput.value.trim();
                    const pillar = pillarSelect.value;

                    if (!questionText || !pillar) {
                        alert("Please enter a question and select a pillar.");
                        return;
                    }

                    fetch("/save-question", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ questionText, pillar }),
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert("Question saved successfully!");
                                questionInput.value = "";
                                pillarSelect.selectedIndex = 0;
                                loadQuestions(); // Reload the questions list
                            } else {
                                alert("Error: " + data.message);
                            }
                        })
                        .catch(error => {
                            console.error("Error saving question:", error);
                            alert("Failed to save question.");
                        });
                });
            } else if (selectedQuestion === "issuesAndStances") {
                // Add dynamic fields for "Issues and Controversies"
                const head = document.createElement("h2");
                head.textContent = "ISSUES AND CONTROVERSIES";
                dynamicFields.appendChild(head);

                const newInput = document.createElement("input");
                newInput.setAttribute("type", "text");
                newInput.setAttribute("id", "dynamicTextarea");
                newInput.setAttribute("placeholder", "List issues here...");
                dynamicFields.append(newInput);

                const addButton = document.createElement("button");
                addButton.textContent = "Add Issue";
                addButton.type = "button";
                addButton.id = "buttonAdd";
                dynamicFields.appendChild(addButton);

                const issueList = document.createElement("ol");
                issueList.setAttribute("id", "issueList");
                dynamicFields.appendChild(issueList);

                const submitButton = document.createElement("button");
                submitButton.textContent = "Submit Issues";
                submitButton.type = "button";
                submitButton.id = "submitIssues";
                dynamicFields.appendChild(submitButton);

                // Re-render existing issues
                renderIssues(issueList);

                addButton.addEventListener("click", function () {
                    const issueValue = newInput.value.trim();
                    if (issueValue) {
                        issues.push(issueValue);
                        newInput.value = "";
                        renderIssues(issueList);
                    }
                });

                submitButton.addEventListener("click", function () {
                    fetch("/submit-issues", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ issues }),
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert("Issues saved successfully!");
                                issues = []; // Clear issues after saving
                                renderIssues(issueList);
                            } else {
                                alert("Error saving issues: " + data.message);
                            }
                        })
                        .catch(error => {
                            console.error("Error saving issues:", error);
                            alert("Failed to save issues.");
                        });
                });
            }
        });

        // Function to load questions from the questionsSheet
        async function loadQuestions() {
            try {
                const response = await fetch('/api/questions');
                const data = await response.json();

                if (data.success) {
                    const questionsContainer = document.getElementById('questionsContainer');
                    questionsContainer.innerHTML = ''; // Clear the list

                    data.questions.forEach((question, index) => {
                        const li = document.createElement('li');
                        li.textContent = question;

                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete';
                        deleteButton.addEventListener('click', () => deleteQuestion(question));

                        li.appendChild(deleteButton);
                        questionsContainer.appendChild(li);
                    });
                } else {
                    alert('Failed to load questions: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading questions:', error);
            }
        }

        // Function to load issues from the stancesSheet
        async function loadIssues() {
            try {
                const response = await fetch('/api/issues');
                const data = await response.json();

                if (data.success) {
                    const issuesContainer = document.getElementById('issuesContainer');
                    issuesContainer.innerHTML = ''; // Clear the list

                    data.issues.forEach((issue, index) => {
                        const li = document.createElement('li');
                        li.textContent = issue;

                        const delButton = document.createElement('button');
                        delButton.textContent = "Delete";
                        delButton.type = "button";
                        delButton.addEventListener("click", () => deleteIssue(issue));

                        li.appendChild(delButton);
                        issuesContainer.appendChild(li);
                    });
                } else {
                    alert('Failed to load issues: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading issues:', error);
            }
        }

        function deleteIssue(columnName) {
            if (!confirm(`Are you sure you want to delete the issue '${columnName}'?`)) return;

            fetch('/api/delete-column', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ columnName, sheetType: 'stances' }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        loadIssues(); // Reload the issues list
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error deleting issue:', error);
                });
        }

        function deleteQuestion(columnName) {
            if (!confirm(`Are you sure you want to clear the question '${columnName}'?`)) return;

            fetch('/api/delete-column', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ columnName, sheetType: 'questions' }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        loadQuestions(); // Reload the questions list
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error clearing question:', error);
                });
        }

        function editQuestion(index, question) {
            const newQuestion = prompt('Edit Question:', question);
            if (newQuestion) {
                // Logic to update the question in the backend
                alert(`Update question at index ${index} to "${newQuestion}" (implement backend logic)`);
            }
        }

        function renderIssues(issueList) {
            issueList.innerHTML = "";
            issues.forEach((issue, index) => {
                const li = document.createElement("li");
                li.textContent = issue;

                const deleteButton = document.createElement("button");
                deleteButton.textContent = "Delete";
                deleteButton.type = "button";
                deleteButton.addEventListener("click", function () {
                    issues.splice(index, 1);
                    renderIssues(issueList);
                });

                li.appendChild(deleteButton);
                issueList.appendChild(li);
            });
        }

        // Load questions and issues when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Only load questions initially
            loadQuestions();
            // Hide issues container by default
            document.getElementById("issuesList").style.display = "none";
        });
    </script>
</body>
</html>
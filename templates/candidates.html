<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/viewcandidates.css">
    <title>Candidates</title>
</head>
<body>
    <!--Navbar Section-->
    <header>
        <nav class="navbar">
            <ul>
                <li><a id="home" class="logo" href="/dashboard">
                    <img src="/static/politekologo1.png" alt="Logo" style="height: 2rem; margin-right: 1.5rem;">POLL-IT-TEKO</a></li>
                <li><a class="navlinks" href="/PiliTugma">PiliTugma</a></li>
                <li><a class="navlinks" href="/candidate">Candidates</a></li>
                <li><a class="navlinks" href="/voting">Voting</a></li>
                <li><a class="navlinks" href="/results">Results</a></li>
            </ul>
        </nav>
    </header>

    <!-- Candidates Section -->
    <section class="candidates">
        <!-- Chairperson Section -->
        <div class="position">
            <h2>Chairperson</h2>
            <ul>
                {% for candidate in chairpersons %}
                <li>
                    <div class="candidate-card">
                        <div class="candidate-image">
                            <img src="{{ candidate.photo }}" class="candidateprof" alt="Candidate Image">
                        </div>
                        <div class="candidate-details"><h3>{{ candidate.last_name }}, {{ candidate.first_name }}</h3>
                            <p>{{ candidate.biography[:120] }}{% if candidate.biography|length > 120 %}...{% endif %}</p>
                            <a class="view-profile-btn" data-id="{{ candidate.row_id }}">View Profile</a>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>

        <!-- Vice Chairperson Section -->
        <div class="position">
            <h2>Vice Chairperson</h2>
            <ul>
                {% for candidate in vice_chairpersons %}
                <li>
                    <div class="candidate-card">
                        <div class="candidate-image">
                            <img src="{{ candidate.photo }}" alt="Candidate Image">
                        </div>
                        <div class="candidate-details">
                            <h3>{{ candidate.last_name }}, {{ candidate.first_name }}</h3>
                            <p>{{ candidate.biography[:120] }}{% if candidate.biography|length > 120 %}...{% endif %}</p>
                            <!-- Corrected data-id attribute -->
                            <a class="view-profile-btn" data-id="{{ candidate.row_id }}">View Profile</a>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
    </section>

<!--Modal Structure-->
<div id="modal2" class="modal2">
    <div class="modal2-content">
        <span class="close-btn2" id="close-modal2">&times;</span>
            <div class="modal2-header">
                <div class="modal2-image">
                    <img id="modal2-image" src="/static/default-profile.png" alt="Candidate Image">
                </div>

                <div class="left-header">
                    <div class="modal2-header-details">
                        <h2 id="modal2-name"></h2>
                        <div class="modal2-header-lower">
                            <p id="modal2-age-region"></p>
                            <p id="modal2-party"></p>
                        </div>
                    </div>

                    <div class="modal2-bio">
                        <p id="modal2-biography"></p>
                    </div>
                </div>  
            
            </div>

        <div class="modal2-body">

            <div class="modal2-body-left">
                <div class="portfolio-section">
                    <h3>Portfolio</h3>
                        
                            <h4>Educational Background</h4>
                            <ul id="modal2-education"></ul>
                            <br>
                            <h4>Leadership Experience</h4>
                            <ul id="modal2-leadership"></ul>
                </div>
            </div>
            
            <div class="modal2-body-right">
                <h4>Achievements</h4>
                <ul id="modal2-achievements"></ul>
            </div>
        </div>

        <div class="modal2-plat">
            <h3>Platforms</h3>
            <ul id="modal2-platforms"></ul>
        </div>

    </div>
</div>

    <!--Footer Section-->
    <footer class="footer">
        <div class="footer-background"></div>
        <div class="footer-content">
            <div class="footer-column footer-logo">
                <img src="/static/logo_footer.png" alt="Logo" style="height: 129px; width: 124px;">
            </div>
            <div class="footer-column footer-candidate">
                <h2>CANDIDATE</h2>
                <ul>
                    <li><a href="/candidate">Candidate Information</a></li>
                    <li><a href="/PiliTugma">Start Preference Testing</a></li>
                </ul>
            </div>
            <div class="footer-column footer-voting">
                <h2>VOTING</h2>
                <ul>
                    <li><a href="/voting">Start Voting</a></li>
                    <li><a href="/results">View Results</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-divider"></div>
    </footer>
</body>
</html>

<script>
    document.addEventListener('DOMContentLoaded', () => {
    const modal2 = document.getElementById('modal2');
    const closeModal2 = document.getElementById('close-modal2');
    let viewProfileButtons = []; // To be populated after data loads

    // API Base URL (without trailing slash)
    const apiBaseUrl = "https://psgc.gitlab.io/api";

    const regionMap = {};
    const provinceMap = {};
    const cityMap = {};

    // Fetch all location data first
    Promise.all([
        fetch(`${apiBaseUrl}/regions`).then(res => res.json()),
        fetch(`${apiBaseUrl}/provinces`).then(res => res.json()),
        fetch(`${apiBaseUrl}/cities-municipalities`).then(res => res.json())
    ])
    .then(([regions, provinces, cities]) => {
        // Populate regionMap
        regions.forEach(region => {
            const normalizedCode = region.code.padStart(9, '0'); // Normalize region code
            regionMap[normalizedCode] = region.name;
        });
        console.log("Region Map:", regionMap); // Debugging: Log the populated region map

        // Populate provinceMap
        provinces.forEach(province => {
            const normalizedCode = province.code.padStart(9, '0'); // Normalize province code
            provinceMap[normalizedCode] = province.name;
        });
        console.log("Province Map:", provinceMap); // Debugging: Log the populated province map

        // Populate cityMap
        cities.forEach(city => {
            const normalizedCode = city.code.padStart(9, '0'); // Normalize city code
            cityMap[normalizedCode] = city.name;
        });
        console.log("City Map:", cityMap); // Debugging: Log the populated city map

        // Now setup event listeners for view profile buttons
        setupViewProfileButtons();
    })
    .catch(error => {
        console.error("Error fetching location data:", error);
    });

    function setupViewProfileButtons() {
        viewProfileButtons = document.querySelectorAll('.view-profile-btn');
        viewProfileButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const candidateId = button.dataset.id;

                try {
                    const response = await fetch(`/api/candidate/${candidateId}`);
                    const data = await response.json();

                    // Normalize the region, province, and city codes from the database
                    const normalizedRegionCode = data.region.padStart(9, '0');
                    const normalizedProvinceCode = data.province.padStart(9, '0');
                    const normalizedCityCode = data.city.padStart(9, '0');

                    const regionName = regionMap[normalizedRegionCode] || "Unknown Region";
                    const provinceName = provinceMap[normalizedProvinceCode] || "Unknown Province";
                    const cityName = cityMap[normalizedCityCode] || "Unknown City";

                    // Update modal content
                    document.getElementById('modal2-image').src = data.photo || "/static/default-profile.png";
                    document.getElementById('modal2-name').textContent = `${data.last_name}, ${data.first_name}`;
                    document.getElementById('modal2-age-region').textContent = 
                        `${data.age} | ${regionName}, ${provinceName}, ${cityName}`;
                    document.getElementById('modal2-party').textContent = data.party;
                    document.getElementById('modal2-biography').textContent = data.biography;

                    // Populate portfolio
                    const educationList = document.getElementById('modal2-education');
                    educationList.innerHTML = data.education.map(item => `<li>${item}</li>`).join('');

                    const leadershipList = document.getElementById('modal2-leadership');
                    leadershipList.innerHTML = data.leadership.map(item => `<li>${item}</li>`).join('');

                    const achievementsList = document.getElementById('modal2-achievements');
                    achievementsList.innerHTML = data.achievements.map(item => `<li>${item}</li>`).join('');

                    // Populate platforms
                    const platformsList = document.getElementById('modal2-platforms');
                    platformsList.innerHTML = Object.entries(data.platforms)
                        .map(([key, value]) => `<li><strong>${key}:</strong> ${value}</li>`)
                        .join('');

                    // Show modal2
                    modal2.style.display = 'block';
                } catch (error) {
                    console.error("Error fetching candidate:", error);
                }
            });
        });
    }

    // Close modal2
    closeModal2.addEventListener('click', () => {
        modal2.style.display = 'none';
    });

    // Close modal2 when clicking outside content
    window.addEventListener('click', (event) => {
        if (event.target === modal2) {
            modal2.style.display = 'none';
        }
    });
});
</script>
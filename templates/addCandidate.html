<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/candidate.css">
    <title>ADD NEW CANDIDATE</title>
    <style>
        /* Platform section styling */
        .platforms-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        .platforms-header {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            padding-bottom: 5px;
            border-bottom: 2px solid #eee;
        }
        .platform-item {
            margin-bottom: 20px;
        }
        .platform-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }
        .platform-item input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        .platform-item input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52,152,219,0.2);
        }
        .no-platforms {
            color: #7f8c8d;
            font-style: italic;
            padding: 10px;
            text-align: center;
        }
        .error-message {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1>ADD NEW CANDIDATE</h1>
        <form id="candidateForm" onsubmit="submitForm(event)" autocomplete="off" enctype="multipart/form-data">
            <!-- Personal Information Section -->
            <section class="form-section">
                <h2>Personal Information</h2>
                <div class="form-group">
                    <label for="Fname">FIRST NAME</label>
                    <input type="text" id="Fname" name="FirstName" required placeholder="Gem Adrian">
                </div>
                <div class="form-group">
                    <label for="Mname">MIDDLE NAME</label>
                    <input type="text" id="Mname" name="MiddleName" placeholder="Casimero">
                </div>
                <div class="form-group">
                    <label for="Lname">LAST NAME</label>
                    <input type="text" id="Lname" name="LastName" required placeholder="Candaganan">
                </div>
                <div class="form-group">
                    <label for="position">POSITION</label>
                    <select id="position" name="Position" required>
                        <option value="" disabled selected>Loading positions...</option>
                    </select>
                </div>
            </section>

            <!-- Address Information Section -->
            <section class="form-section">
                <h2>Address Information</h2>
                <div class="form-group">
                    <label for="region">REGION</label>
                    <select id="region" name="region" required>
                        <option value="" disabled selected>Select Region</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="province">PROVINCE</label>
                    <select id="province" name="province" required>
                        <option value="" disabled selected>Select Province</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="city">CITY/MUNICIPALITY</label>
                    <select id="city" name="city" required>
                        <option value="" disabled selected>Select City/Municipality</option>
                    </select>
                </div>
            </section>

            <!-- Biography Section -->
            <section class="form-section">
                <div class="form-group">
                    <label for="biography">SHORT BIOGRAPHY</label>
                    <textarea id="biography" name="biography" rows="4" placeholder="Write the candidate's short biography here"></textarea>
                </div>
            </section>

            <!-- Personal Details Section -->
            <section class="form-section">
                <h2>Personal Details</h2>
                <div class="form-group">
                    <label for="bday">BIRTHDAY</label>
                    <input type="date" id="bday" name="bday" required>
                </div>
                <div class="form-group">
                    <label for="Party">POLITICAL PARTY</label>
                    <input type="text" id="Party" name="Party" placeholder="Enter political party">
                </div>
            </section>

            <!-- Education Background Section -->
            <section class="form-section">
                <h2>Educational Background</h2>
                <div class="form-group">
                    <label for="education">ADD EDUCATION</label>
                    <div class="input-group">
                        <input type="text" id="education" placeholder="Enter Educational Background">
                        <button type="button" id="addEducation" class="btn-add">ADD</button>
                    </div>
                    <div class="listed-items">
                        <p>Listed Educational Background</p>
                        <ol id="educationList"></ol>
                    </div>
                </div>
            </section>

            <!-- Leadership Experience Section -->
            <section class="form-section">
                <h2>Leadership Experience</h2>
                <div class="form-group">
                    <label for="experience">ADD EXPERIENCE</label>
                    <div class="input-group">
                        <input type="text" id="experience" placeholder="Enter Leadership Experience">
                        <button type="button" id="addExperience" class="btn-add">ADD</button>
                    </div>
                    <div class="listed-items">
                        <p>Listed Leadership Experience</p>
                        <ol id="experienceList"></ol>
                    </div>
                </div>
            </section>

            <!-- Achievements Section -->
            <section class="form-section">
                <h2>Achievements</h2>
                <div class="form-group">
                    <label for="achievements">ADD ACHIEVEMENTS</label>
                    <div class="input-group">
                        <input type="text" id="achievements" placeholder="Enter Achievements">
                        <button type="button" id="addAchievements" class="btn-add">ADD</button>
                    </div>
                    <div class="listed-items">
                        <p>Listed Achievements</p>
                        <ol id="achievementList"></ol>
                    </div>
                </div>
            </section>

            <!-- Dynamic Platforms Section -->
            <section class="platforms-section">
                <div class="platforms-header">CANDIDATE PLATFORMS</div>
                <div id="platformsContainer">
                    <p class="no-platforms">Loading platform options from pillars sheet...</p>
                </div>
            </section>

            <!-- Issues and Controversies Section -->
            <section class="form-section">
                <div class="form-group">
                    <h2>Issues and Controversies</h2>
                    <div id="issuesContainer">
                        <!-- Issues will be dynamically loaded here -->
                    </div>
                </div>
            </section>

            <!-- Photo Upload Section -->
            <section class="form-section">
                <div class="form-group">
                    <label for="photo">Upload Candidate's Photo:</label>
                    <input type="file" id="photo" name="photo" accept=".jpg,.jpeg,.png">
                </div>
            </section>

            <!-- Form Buttons -->
            <div class="form-actions">
                <button type="submit" id="submit" class="btn-primary">Submit Candidate</button>
                <button type="reset" id="reset" class="btn-secondary">Reset Form</button>
            </div>
        </form>
    </div>

    <script>
        // Arrays to store multiple entries
        let education = [];
        let experience = [];
        let achievements = [];
        let platforms = {}; // Object to store platform values

        // Function to fetch and display platform options from pillars sheet
        async function loadPlatforms() {
            try {
                const response = await fetch('/api/platforms');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const platformTitles = await response.json();
                
                const container = document.getElementById('platformsContainer');
                container.innerHTML = '';
                
                if (!platformTitles || platformTitles.length === 0) {
                    container.innerHTML = '<p class="no-platforms">No platform categories defined in pillars sheet</p>';
                    return;
                }
                
                // Create a platform input for each title from pillars sheet (A1, B1, C1)
                platformTitles.forEach((title, index) => {
                    if (!title || !title.trim()) return; // Skip empty titles
                    
                    const platformDiv = document.createElement('div');
                    platformDiv.className = 'platform-item';
                    
                    const label = document.createElement('label');
                    label.textContent = title.toUpperCase();
                    label.setAttribute('for', `platform-${index}`);
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = `platform-${index}`;
                    input.name = `platform_${index}`;
                    input.placeholder = `Enter candidate's ${title} platform`;
                    input.setAttribute('data-pillar-title', title);
                    
                    // Store platform value when changed
                    input.addEventListener('input', function() {
                        const pillarTitle = this.getAttribute('data-pillar-title');
                        platforms[pillarTitle] = this.value;
                    });
                    
                    platformDiv.appendChild(label);
                    platformDiv.appendChild(input);
                    container.appendChild(platformDiv);
                });
                
            } catch (error) {
                console.error('Error loading platforms:', error);
                const container = document.getElementById('platformsContainer');
                container.innerHTML = `
                    <p class="no-platforms">Error loading platform options</p>
                    <p class="error-message">${error.message}</p>
                `;
            }
        }

        // Function to fetch and display issues
        async function loadIssues() {
            try {
                const response = await fetch('/api/issues');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json(); // Parse the JSON response
                const issues = data.issues; // Access the "issues" array

                const container = document.getElementById('issuesContainer');
                container.innerHTML = '';

                if (!issues || issues.length === 0) {
                    container.innerHTML = '<p class="no-issues">No issues available</p>';
                    return;
                }

                // Create a dropdown for each issue
                issues.forEach((issue, index) => {
                    const issueDiv = document.createElement('div');
                    issueDiv.className = 'issue-item';

                    const label = document.createElement('label');
                    label.textContent = issue;
                    label.setAttribute('for', `issue-${index}`);

                    const select = document.createElement('select');
                    select.id = `issue-${index}`;
                    select.name = `stances[${issue}]`;
                    select.required = true;

                    const options = ['No Answer', 'Agree', 'Disagree', 'Abstain'];
                    options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option;
                        opt.textContent = option;
                        select.appendChild(opt);
                    });

                    issueDiv.appendChild(label);
                    issueDiv.appendChild(select);
                    container.appendChild(issueDiv);
                });
            } catch (error) {
                console.error('Error loading issues:', error);
                const container = document.getElementById('issuesContainer');
                container.innerHTML = `
                    <p class="no-issues">Error loading issues</p>
                    <p class="error-message">${error.message}</p>
                `;
            }
        }

        // Modified form submission handler
        function submitForm(e) {
            e.preventDefault();

            const form = document.getElementById("candidateForm");
            const formData = new FormData(form);

            // Append arrays and platforms to FormData
            formData.append("education", JSON.stringify(education));
            formData.append("experience", JSON.stringify(experience));
            formData.append("achievements", JSON.stringify(achievements));
            formData.append("platforms", JSON.stringify(platforms));

            const stances = {};
            document.querySelectorAll("#issuesContainer select").forEach(select => {
                const issue = select.name.replace("stances[", "").replace("]", "").trim().toLowerCase();
                stances[issue] = select.value;
            });

            formData.append("stances", JSON.stringify(stances));

            const submitButton = document.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = "Submitting...";
            
            fetch("/submitAddCandidate", {
                method: "POST",
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Candidate added successfully!");
                    resetForm();
                } else {
                    alert("Error: " + data.message);
                }
            })
            .catch(error => {
                console.error("Submission error:", error);
                alert("Failed to submit candidate data.");
            });
        }

        // New function to completely reset the form
        function resetForm() {
            // Reset the HTML form
            const form = document.getElementById("candidateForm");
            form.reset();
            
            // Clear all JavaScript arrays
            education = [];
            experience = [];
            achievements = [];
            platforms = {};
            
            // Update all lists to show empty
            updateEducationList();
            updateExperienceList();
            updateAchievementList();
            
            // Clear platform inputs
            const platformInputs = document.querySelectorAll('#platformsContainer input[type="text"]');
            platformInputs.forEach(input => {
                input.value = '';
            });
            
            // Reset file input
            document.getElementById("photo").value = '';
            
            // Reset select dropdowns to their initial state
            document.getElementById("position").selectedIndex = 0;
            document.getElementById("region").selectedIndex = 0;
            document.getElementById("province").selectedIndex = 0;
            document.getElementById("city").selectedIndex = 0;
        }

        // Load positions and platforms when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load positions
            fetch('/api/positions')
                .then(response => {
                    if (!response.ok) throw new Error('Failed to load positions');
                    return response.json();
                })
                .then(data => {
                    const positionSelect = document.getElementById('position');
                    positionSelect.innerHTML = '<option value="" disabled selected>Select Position</option>';
                    data.positions.forEach(position => {
                        const option = document.createElement('option');
                        option.value = position;
                        option.textContent = position;
                        positionSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading positions:', error);
                    document.getElementById('position').innerHTML = 
                        '<option value="" disabled selected>Failed to load positions</option>';
                });

            // Load dynamic platforms from pillars sheet
            loadPlatforms();

            // Load issues
            loadIssues();
        });

        // [Rest of your existing JavaScript for education/experience/achievements management]
        // Education list management
        document.getElementById("addEducation").addEventListener('click', function() {
            const educationInput = document.getElementById('education');
            const educationName = educationInput.value.trim();
            if (educationName && !education.includes(educationName)) {
                education.push(educationName);
                educationInput.value = '';
                updateEducationList();
            }
        });

        function updateEducationList() {
            const educationList = document.getElementById('educationList');
            educationList.innerHTML = '';
            education.forEach((edu, index) => {
                const li = document.createElement('li');
                li.textContent = edu;
                
                const delBtn = document.createElement('button');
                delBtn.textContent = "Delete";
                delBtn.type = "button";
                delBtn.className = "btn-delete";
                delBtn.addEventListener('click', function() {
                    education.splice(index, 1);
                    updateEducationList();
                });
                
                li.appendChild(delBtn);
                educationList.appendChild(li);
            });
        }

        // Experience list management
        document.getElementById("addExperience").addEventListener('click', function() {
            const experienceInput = document.getElementById('experience');
            const experienceName = experienceInput.value.trim();
            if (experienceName && !experience.includes(experienceName)) {
                experience.push(experienceName);
                experienceInput.value = '';
                updateExperienceList();
            }
        });

        function updateExperienceList() {
            const experienceList = document.getElementById('experienceList');
            experienceList.innerHTML = '';
            experience.forEach((exp, index) => {
                const li = document.createElement('li');
                li.textContent = exp;
                
                const delBtn = document.createElement('button');
                delBtn.textContent = "Delete";
                delBtn.type = "button";
                delBtn.className = "btn-delete";
                delBtn.addEventListener('click', function() {
                    experience.splice(index, 1);
                    updateExperienceList();
                });
                
                li.appendChild(delBtn);
                experienceList.appendChild(li);
            });
        }

        // Achievements list management
        document.getElementById("addAchievements").addEventListener('click', function() {
            const achievementsInput = document.getElementById('achievements');
            const achievementName = achievementsInput.value.trim();
            if (achievementName && !achievements.includes(achievementName)) {
                achievements.push(achievementName);
                achievementsInput.value = '';
                updateAchievementList();
            }
        });

        function updateAchievementList() {
            const achievementList = document.getElementById('achievementList');
            achievementList.innerHTML = '';
            achievements.forEach((ach, index) => {
                const li = document.createElement('li');
                li.textContent = ach;
                
                const delBtn = document.createElement('button');
                delBtn.textContent = "Delete";
                delBtn.type = "button";
                delBtn.className = "btn-delete";
                delBtn.addEventListener('click', function() {
                    achievements.splice(index, 1);
                    updateAchievementList();
                });
                
                li.appendChild(delBtn);
                achievementList.appendChild(li);
            });
        }

        // Region, Province, City Selector
        const apiBaseUrl = "https://psgc.gitlab.io/api/";
        const regionSelect = document.getElementById("region");
        const provinceSelect = document.getElementById("province");
        const citySelect = document.getElementById("city");

        // Fetch regions
        fetch(`${apiBaseUrl}/regions`)
            .then(response => response.json())
            .then(data => {
                regionSelect.innerHTML = '<option value="" disabled selected>Select Region</option>';
                data.forEach(region => {
                    const option = document.createElement("option");
                    option.value = region.code;
                    option.textContent = region.name;
                    regionSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error("Error fetching regions:", error);
                regionSelect.innerHTML = '<option value="" disabled selected>Error loading regions</option>';
            });

        // Fetch provinces based on selected region
        regionSelect.addEventListener("change", function() {
            const regionCode = this.value;
            provinceSelect.innerHTML = '<option value="" disabled selected>Select Province</option>';
            citySelect.innerHTML = '<option value="" disabled selected>Select City/Municipality</option>';

            if (!regionCode) return;

            fetch(`${apiBaseUrl}/regions/${regionCode}/provinces`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(province => {
                        const option = document.createElement("option");
                        option.value = province.code;
                        option.textContent = province.name;
                        provinceSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error("Error fetching provinces:", error);
                    provinceSelect.innerHTML = '<option value="" disabled selected>Error loading provinces</option>';
                });
        });

        // Fetch cities based on selected province
        provinceSelect.addEventListener("change", function() {
            const provinceCode = this.value;
            citySelect.innerHTML = '<option value="" disabled selected>Select City/Municipality</option>';

            if (!provinceCode) return;

            fetch(`${apiBaseUrl}/provinces/${provinceCode}/cities-municipalities/`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(city => {
                        const option = document.createElement("option");
                        option.value = city.code;
                        option.textContent = city.name;
                        citySelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error("Error fetching cities:", error);
                    citySelect.innerHTML = '<option value="" disabled selected>Error loading cities</option>';
                });
        });
    </script>
</body>
</html>